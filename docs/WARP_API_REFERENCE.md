# Warp GraphQL API 参考

> 用于 Ai Switch 集成 Warp Rules / MCP 云端管理

## 概述

Warp 的 Rules 和 MCP 服务器配置存储在云端（Warp Drive），通过 GraphQL API 进行 CRUD 操作。Ai Switch 通过此 API 实现与 Warp 的双向同步。

- **Base URL**: `https://app.warp.dev/graphql/v2`
- **认证**: `Authorization: Bearer <token>`（API Key 格式 `wk-1.xxxxxxxx` 或 Firebase JWT）

## 通用请求规范

### 必需请求头

```
Content-Type: application/json
Authorization: Bearer <token>
x-warp-client-id: warp-app
x-warp-client-version: v0.2026.01.21.08.14.stable_04
x-warp-os-category: <macOS|Linux|Windows>
x-warp-os-name: <macOS|Linux|Windows>
x-warp-os-version: <系统版本号>
```

### RequestContext（所有请求必需）

```json
{
  "requestContext": {
    "clientContext": {
      "version": "v0.2026.01.21.08.14.stable_04"
    },
    "osContext": {
      "category": "macOS",
      "linuxKernelVersion": null,
      "name": "macOS",
      "version": "15.4.1"
    }
  }
}
```

> `x-warp-client-version` 和 `clientContext.version` 应跟踪 Warp 稳定版版本号。

---

## 一、Rules API

Rules 存储为 `GenericStringObject`，format 为 `JsonAIFact`。

### 数据结构

```json
{
  "memory": {
    "name": "规则名称",
    "content": "规则内容",
    "is_autogenerated": false
  }
}
```

过滤条件：`format === "JsonAIFact"` 且 `serializedModel` 包含 `memory` 字段。

### 1.1 获取所有规则

**Endpoint**: `POST /graphql/v2?op=GetUpdatedCloudObjects`

```graphql
query GetUpdatedCloudObjects($input: UpdatedCloudObjectsInput!, $requestContext: RequestContext!) {
  updatedCloudObjects(input: $input, requestContext: $requestContext) {
    __typename
    ... on UpdatedCloudObjectsOutput {
      genericStringObjects {
        format
        metadata {
          uid
          trashedTs
          revisionTs
          creatorUid
          lastEditorUid
        }
        serializedModel
      }
    }
  }
}
```

**Variables**:

```json
{
  "input": {
    "forceRefresh": true,
    "genericStringObjects": [],
    "folders": [],
    "notebooks": [],
    "workflows": []
  },
  "requestContext": { "..." }
}
```

**响应关键字段**:
- `genericStringObjects[].metadata.uid` — 规则唯一 ID
- `genericStringObjects[].metadata.revisionTs` — 版本时间戳（更新时必需）
- `genericStringObjects[].serializedModel` — JSON 字符串，包含 `memory` 结构

### 1.2 创建规则

**Endpoint**: `POST /graphql/v2?op=CreateGenericStringObject`

```graphql
mutation CreateGenericStringObject($input: CreateGenericStringObjectInput!, $requestContext: RequestContext!) {
  createGenericStringObject(input: $input, requestContext: $requestContext) {
    __typename
    ... on CreateGenericStringObjectOutput {
      clientId
      genericStringObject {
        format
        metadata { uid revisionTs }
        serializedModel
      }
      revisionTs
    }
    ... on UserFacingError {
      error {
        __typename
        ... on GenericStringObjectUniqueKeyConflict { message }
      }
    }
  }
}
```

**Variables**:

```json
{
  "input": {
    "genericStringObject": {
      "clientId": "Client-<uuid>",
      "entrypoint": "Unknown",
      "format": "JsonAIFact",
      "initialFolderId": null,
      "serializedModel": "{\"memory\":{\"name\":\"规则名称\",\"content\":\"规则内容\",\"is_autogenerated\":false}}",
      "uniquenessKey": null
    },
    "owner": { "type": "User" }
  },
  "requestContext": { "..." }
}
```

**字段说明**:
- `clientId` — 客户端生成，格式 `Client-{UUID}`
- `entrypoint` — 固定 `"Unknown"`
- `format` — 固定 `"JsonAIFact"`
- `serializedModel` — JSON 字符串化的 `{memory: {name, content, is_autogenerated}}`
- `uniquenessKey`（可选）— `{key: "your-key", uniquePer: "User"}` 用于幂等创建

### 1.3 更新规则

**Endpoint**: `POST /graphql/v2?op=UpdateGenericStringObject`

```graphql
mutation UpdateGenericStringObject($input: UpdateGenericStringObjectInput!, $requestContext: RequestContext!) {
  updateGenericStringObject(input: $input, requestContext: $requestContext) {
    __typename
    ... on UpdateGenericStringObjectOutput {
      update {
        __typename
        ... on ObjectUpdateSuccess {
          lastEditorUid
          revisionTs
        }
        ... on GenericStringObjectUpdateRejected {
          conflictingGenericStringObject {
            metadata { revisionTs uid }
            serializedModel
          }
        }
      }
    }
  }
}
```

**Variables**:

```json
{
  "input": {
    "uid": "<规则 uid>",
    "revisionTs": "<当前 revisionTs>",
    "serializedModel": "{\"memory\":{\"name\":\"更新名称\",\"content\":\"更新内容\",\"is_autogenerated\":false}}"
  },
  "requestContext": { "..." }
}
```

> **乐观锁**: `revisionTs` 必须与服务端当前版本匹配，否则返回 `GenericStringObjectUpdateRejected`。冲突时需先 fetch 最新版本再重试。

### 1.4 删除规则

**Endpoint**: `POST /graphql/v2?op=DeleteObject`

```graphql
mutation DeleteObject($input: DeleteObjectInput!, $requestContext: RequestContext!) {
  deleteObject(input: $input, requestContext: $requestContext) {
    __typename
    ... on DeleteObjectOutput {
      deletedUids
      success
    }
  }
}
```

**Variables**:

```json
{
  "input": { "uid": "<规则 uid>" },
  "requestContext": { "..." }
}
```

---

## 二、MCP 服务器 API

MCP 服务器存储为 `GenericStringObject`，format 为 `JsonTemplatableMCPServer`。

### 数据结构

```json
{
  "uuid": "<uuid>",
  "name": "服务器名称",
  "description": null,
  "template": {
    "json": "{\n  \"<name>\": {\n    \"serverUrl\": \"<url>\"\n  }\n}",
    "variables": []
  },
  "version": 1738000000,
  "gallery_data": null
}
```

- `template.json` 为字符串化的 MCP 服务器配置 JSON
- `version` 为 epoch 时间戳

过滤条件：`format === "JsonTemplatableMCPServer"`。

### 2.1 获取所有 MCP 服务器

同 Rules 使用 `GetUpdatedCloudObjects`，过滤 `format === "JsonTemplatableMCPServer"` 的对象。

### 2.2 创建 MCP 服务器

同 Rules 使用 `CreateGenericStringObject`，区别：

```json
{
  "input": {
    "genericStringObject": {
      "clientId": "Client-<uuid>",
      "entrypoint": "Unknown",
      "format": "JsonTemplatableMCPServer",
      "initialFolderId": null,
      "serializedModel": "{\"uuid\":\"<uuid>\",\"name\":\"<name>\",\"description\":null,\"template\":{\"json\":\"{\\n  \\\"<name>\\\": {\\n    \\\"serverUrl\\\": \\\"<url>\\\"\\n  }\\n}\",\"variables\":[]},\"version\":<epoch>,\"gallery_data\":null}",
      "uniquenessKey": {
        "key": "templatable_mcp_server_<uuid>",
        "uniquePer": "User"
      }
    },
    "owner": { "uid": "", "type": "User" }
  },
  "requestContext": { "..." }
}
```

### 2.3 更新 / 删除 MCP 服务器

与 Rules 的更新、删除操作完全相同（`UpdateGenericStringObject` / `DeleteObject`），仅 `serializedModel` 格式不同。

---

## 三、用量统计（本地数据库）

Warp 在本地维护一个 SQLite 数据库，记录所有对话的 token 消耗和工具使用数据。Ai Switch 直接读取此数据库获取用量统计，**无需 API Token**。

### 3.1 数据库路径

| 平台 | 路径 |
|------|------|
| macOS | `~/Library/Group Containers/2BBY89MBSN.dev.warp/Library/Application Support/dev.warp.Warp-Stable/warp.sqlite` |
| Windows | `%LOCALAPPDATA%\Warp\Warp\data\warp.sqlite` |

> macOS 需要 **Full Disk Access** 权限才能读取此数据库。

### 3.2 数据库中的用量字段

对话数据存储在 `warp.sqlite` 中，每条对话的 `conversation_usage_metadata` JSON 包含：

**Token 消耗**（按模型分组）:
```json
{
  "token_usage": [
    {
      "model_id": "claude-4-5-sonnet",
      "warp_tokens": 12345,
      "byok_tokens": 0
    }
  ]
}
```
- `model_id` — 使用的模型标识
- `warp_tokens` — Warp 提供的 token 消耗
- `byok_tokens` — 用户自带 Key (BYOK) 的 token 消耗

**积分消耗**:
- `credits_spent` — 该对话消耗的积分数

**工具使用统计** (`tool_usage_metadata`):
```json
{
  "run_command_stats": { "count": 5 },
  "read_files_stats": { "count": 12 },
  "search_codebase_stats": { "count": 3 },
  "grep_stats": { "count": 8 },
  "file_glob_stats": { "count": 2 },
  "call_mcp_tool_stats": { "count": 1 },
  "apply_file_diff_stats": {
    "count": 4,
    "lines_added": 120,
    "lines_removed": 30,
    "files_changed": 6
  }
}
```

### 3.3 Rust 读取实现参考

```rust
/// 获取 Warp 本地数据库路径
pub fn warp_db_path() -> Result<PathBuf> {
    #[cfg(target_os = "macos")]
    {
        let home = std::env::var("HOME")?;
        Ok(PathBuf::from(format!(
            "{}/Library/Group Containers/2BBY89MBSN.dev.warp/\
             Library/Application Support/dev.warp.Warp-Stable/warp.sqlite",
            home
        )))
    }
    #[cfg(target_os = "windows")]
    {
        let local = std::env::var("LOCALAPPDATA")?;
        Ok(PathBuf::from(format!(
            "{}\\Warp\\Warp\\data\\warp.sqlite", local
        )))
    }
}
```

读取数据库后，遍历对话记录并解析 `conversation_usage_metadata` JSON，汇总：
- 总积分消耗 (`credits_spent` 累加)
- 总 token 使用 (`warp_tokens + byok_tokens` 按 `model_id` 分组累加)
- 工具使用次数（各 `*_stats.count` 累加）
- 代码变更统计（`lines_added / lines_removed / files_changed` 累加）

### 3.4 权限检测

读取前应先检测数据库文件是否存在及是否可访问：
- 文件不存在 → 提示用户确认 Warp 已安装且使用过
- macOS `PermissionDenied` → 引导用户开启 系统设置 > 隐私与安全 > 完全磁盘访问权限
- Windows 一般无权限问题

---

## 四、错误处理

### 常见错误类型

| 错误 | 说明 | 处理方式 |
|------|------|----------|
| `GenericStringObjectUniqueKeyConflict` | uniquenessKey 冲突 | 对象已存在，跳过或更新 |
| `GenericStringObjectUpdateRejected` | revisionTs 不匹配 | 重新 fetch 后重试 |
| `SharedObjectsLimitExceeded` | 共享对象超限 | 提示用户清理 |
| `PersonalObjectsLimitExceeded` | 个人对象超限 | 提示用户清理 |
| `AccountDelinquencyError` | 账户欠费 | 提示用户 |

---

## 五、同步策略

Ai Switch 同步 Rules/MCP 到 Warp 时支持两种策略：

### 完全覆盖

1. `GetUpdatedCloudObjects` 获取远程所有对象
2. `DeleteObject` 逐个删除现有对象
3. `CreateGenericStringObject` 逐个创建本地对象

> 优点：保证远程与本地完全一致。缺点：会删除用户在 Warp 中手动添加的内容。

### 增量合并

1. `GetUpdatedCloudObjects` 获取远程对象
2. 按 name 比对，仅创建不存在的 / 更新已变更的
3. 不删除远程多出的对象

> 优点：保留用户手动内容。缺点：可能存在冗余。

### 批量操作注意事项

- 添加适当延时（建议 100-200ms 间隔），避免触发 API 限流
- 单个操作失败时应记录并继续，不中断整体同步
- 更新操作使用乐观锁，冲突时自动重试（最多 3 次）
